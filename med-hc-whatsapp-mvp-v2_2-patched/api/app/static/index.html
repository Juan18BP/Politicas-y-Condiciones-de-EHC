<!DOCTYPE html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Envío de HC por WhatsApp</title>
<script src="https://cdn.tailwindcss.com"></script>
</head><body class="bg-gradient-to-b from-indigo-50 to-white text-slate-900 min-h-screen">
<div class="max-w-3xl mx-auto p-6">
<header class="mb-6 flex items-center gap-3">
  <div class="w-10 h-10 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-bold">HC</div>
  <div><h1 class="text-2xl font-bold">Envío de Historias Clínicas</h1>
  <p class="text-sm text-slate-600">Sube el PDF, verifica el número y envía por WhatsApp.</p></div>
</header>
<section class="bg-white rounded-2xl shadow p-6 space-y-4 border border-slate-100">
  <div id="dropzone" class="border-2 border-dashed rounded-xl p-8 text-center cursor-pointer hover:bg-slate-50 transition">
    <p class="font-medium">Arrastra y suelta el PDF aquí o haz clic para seleccionar</p>
    <p class="text-xs text-slate-500 mt-1">Solo PDF. Máx 25 MB.</p>
    <input id="fileInput" type="file" accept="application/pdf" class="hidden" />
  </div>
  <div id="progressWrap" class="hidden">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm text-slate-600">Subiendo PDF…</span>
      <span id="progressPct" class="text-sm font-medium text-slate-700">0%</span>
    </div>
    <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden"><div id="progressBar" class="h-2 bg-indigo-600 transition-all" style="width:0%"></div></div>
  </div>
  <div id="preview" class="hidden">
    <h2 class="font-semibold mt-2">Vista previa</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="text-sm text-slate-600">Paciente</label><input id="patientName" class="w-full border rounded-lg p-2" readonly></div>
      <div><label class="text-sm text-slate-600">Correo detectado</label><input id="email" class="w-full border rounded-lg p-2" readonly></div>
      <div class="md:col-span-2"><label class="text-sm text-slate-600">Teléfono WhatsApp (E.164, ej: +573001112233)</label><input id="phone" class="w-full border rounded-lg p-2" placeholder="+57..."></div>
    </div>
    <div class="flex items-center gap-2 mt-4 flex-wrap">
      <button id="templateBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition">Enviar plantilla</button>
      <button id="textBtn" class="px-4 py-2 rounded-lg bg-slate-700 text-white hover:bg-slate-800 transition">Texto de prueba</button>
      <button id="sendBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">Enviar PDF</button>
      <span id="status" class="text-sm text-slate-600"></span>
    </div>
    <div id="respBox" class="mt-3 text-xs text-slate-500 whitespace-pre-wrap"></div>
  </div>
</section>
<footer class="mt-8 text-xs text-slate-500"><p>Los archivos se eliminan a los 7 días. Evita incluir datos clínicos en el mensaje.</p></footer>
</div>
<script>
const dropzone=document.getElementById('dropzone'),fileInput=document.getElementById('fileInput'),preview=document.getElementById('preview'),patientName=document.getElementById('patientName'),email=document.getElementById('email'),phone=document.getElementById('phone'),sendBtn=document.getElementById('sendBtn'),templateBtn=document.getElementById('templateBtn'),textBtn=document.getElementById('textBtn'),statusEl=document.getElementById('status'),respBox=document.getElementById('respBox'),progressWrap=document.getElementById('progressWrap'),progressBar=document.getElementById('progressBar'),progressPct=document.getElementById('progressPct');
let uploadId=null;
function resetUI(){uploadId=null;preview.classList.add('hidden');statusEl.textContent='';respBox.textContent='';}
dropzone.addEventListener('click',()=>fileInput.click());
dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.classList.add('bg-slate-100');});
dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('bg-slate-100'));
dropzone.addEventListener('drop',e=>{e.preventDefault();dropzone.classList.remove('bg-slate-100');const f=e.dataTransfer.files[0];if(f)handleFile(f);});
fileInput.addEventListener('change',()=>{const f=fileInput.files[0];if(f)handleFile(f);});
async function handleFile(file){
  resetUI(); if(file.type!=='application/pdf'){alert('Solo PDF.');return;} if(file.size>25*1024*1024){alert('Máx 25 MB.');return;}
  progressWrap.classList.remove('hidden');progressBar.style.width='0%';progressPct.textContent='0%';statusEl.textContent='Subiendo y analizando PDF...';sendBtn.disabled=true;templateBtn.disabled=true;textBtn.disabled=true;
  const form=new FormData(); form.append('file',file); const xhr=new XMLHttpRequest(); xhr.open('POST','/api/upload',true);
  xhr.upload.onprogress=(e)=>{if(e.lengthComputable){const p=Math.round((e.loaded/e.total)*100);progressBar.style.width=p+'%';progressPct.textContent=p+'%';}};
  xhr.onload=()=>{progressBar.style.width='100%';progressPct.textContent='100%';
    if(xhr.status>=200&&xhr.status<300){const data=JSON.parse(xhr.responseText);uploadId=data.upload_id;patientName.value=data.patient_name||'';email.value=data.detected_email||'';phone.value=data.detected_phone_e164||'';preview.classList.remove('hidden');statusEl.textContent='Listo para enviar.';}
    else{alert('Error al subir: '+xhr.responseText);statusEl.textContent='Error al subir.';}
    setTimeout(()=>progressWrap.classList.add('hidden'),700);sendBtn.disabled=false;templateBtn.disabled=false;textBtn.disabled=false;
  };
  xhr.onerror=()=>{alert('Error de red al subir.');progressWrap.classList.add('hidden');sendBtn.disabled=false;templateBtn.disabled=false;textBtn.disabled=false;};
  xhr.send(form);
}
templateBtn.addEventListener('click',async()=>{
  const to=phone.value.trim(); if(!to){alert('Ingrese número +57...');return;}
  statusEl.textContent='Enviando plantilla...'; templateBtn.disabled=true;
  const res=await fetch('/api/send/template',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to_phone_e164:to})});
  const txt=await res.text(); respBox.textContent=txt;
  if(!res.ok){alert('Error al enviar plantilla'); statusEl.textContent='Error.';} else {statusEl.textContent='Plantilla enviada.';}
  templateBtn.disabled=false;
});
textBtn.addEventListener('click',async()=>{
  const to=phone.value.trim(); if(!to){alert('Ingrese número +57...');return;}
  statusEl.textContent='Enviando texto...'; textBtn.disabled=true;
  const res=await fetch('/api/send/text',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to_phone_e164:to, body:'Prueba posterior a plantilla ✅'})});
  const txt=await res.text(); respBox.textContent=txt;
  if(!res.ok){alert('Error al enviar texto'); statusEl.textContent='Error.';} else {statusEl.textContent='Texto enviado.';}
  textBtn.disabled=false;
});
sendBtn.addEventListener('click',async()=>{
  if(!uploadId){alert('Primero sube un PDF');return;}
  const to=phone.value.trim(); if(!to){alert('Ingrese número +57...');return;}
  statusEl.textContent='Enviando PDF...'; sendBtn.disabled=true;
  const res=await fetch('/api/send/whatsapp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({upload_id:uploadId,to_phone_e164:to,caption:'Documentación clínica'})});
  const txt=await res.text(); respBox.textContent=txt;
  if(!res.ok){alert('Error al enviar PDF'); statusEl.textContent='Error.';} else {statusEl.textContent='PDF enviado.';}
  sendBtn.disabled=false;
});
</script>
</body></html>
